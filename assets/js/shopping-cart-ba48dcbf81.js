function checkedGoods(){var t=0,e=0,o=0,n=0;$(".ccart-con .count-price").each(function(c,i){var a=$(this).prop("checked");if(n++,a){var r=parseInt($(this).data("nums"));o++,t+=parseInt($(this).data("qcb"))*r,e+=parseFloat($(this).data("price"))*r}}),o!=n?$("#check_all").prop("checked",!1):$("#check_all").prop("checked",!0),$("#count_qcb").text(t),$("#count_price").text(e.toFixed(2)),$("#ck_lenght").text(o)}function shopAllChecked(t){t.parent(".ccart-title").sibling(".ccart-content").find(".count-price").each(function(t,e){$(e).prop("checked")?$(e).prop("checked",!0):$(e).prop("checked",!1)})}function transformRequest(t){var e="";for(var o in t)e+=encodeURIComponent(o)+"="+encodeURIComponent(t[o])+"&";return e}var conf=1,toke=token(),goodsList=["../assets/data/shopping-cart.json",baseUrl()+"index.php?r=cart&token="+toke],delGoods=["",baseUrl()+"index.php?r=cart&m=delCart&token="+toke],normsList=["../assets/data/goods-attr.json",baseUrl()+"index.php?r=cart&m=get_cart_goods_attr&token="+toke],couponsList=["../assets/data/coupons.json",baseUrl()+"index.php?r=Discount_coupon&m=getShopCoupon&token="+toke],couponList=["",baseUrl()+"index.php?r=User_discount_coupon&m=addUserCoupon"],editGoods=["",baseUrl()+"index.php?r=cart&m=editcart"],goodsAttr=new Vue({el:"#goods_edit_attr",data:{parameter:[],ruleIndex:0,imgSrc:""},filters:{formatQcb1:function(t,e){return e||(e=1),t*e},formatMoney1:function(t,e){return e||(e=1),"￥"+(t*e).toFixed(2)}},mounted:function(){},methods:{showParameter:function(t){var e=this;e.$nextTick(function(){axios.post(normsList[conf],transformRequest({goods_id:t.goods_id,cart_id:t.id,token:toke})).then(function(t){var o=t.data;"1"==o.res?e.parameter=o.data:layer.open({content:"数据错误！",skin:"msg",time:1})})})},selectRule:function(t,e,o,n,c){this.$nextTick(function(){$('li[data-pub="'+n+'"]').removeClass("active"),$('li[data-pro="'+o+'"]').addClass("active"),$("."+n).html(t),$("."+n).attr("attrId",c)})},changeNum:function(t,e){var o=this,n=t.cart_number,c=t.kucun;if(e>0){if(!(n<c))return t.number=t.kucun,layer.open({content:"库存不足！",skin:"msg",time:1}),!1;t.cart_number++}else--t.cart_number<1&&(t.cart_number=1);axios.post(editGoods[conf],transformRequest({goods_id:t.goods_id,cart_id:t.cart_id,num:t.cart_number,token:toke})).then(function(e){"1"==e.data.res?o.$nextTick(function(){checkedGoods()}):t.cart_number--})},selectFinish:function(t){var e=!0,o="",n="";if($(".ruleClass b").each(function(t,c){if(checkedGoods(),""==$(c).text())return layer.open({content:"请选择"+$(c).attr("data-val"),skin:"msg",time:2}),e=!1,!1;""==o?(o=$(c).attr("attrId"),n=$(c).text()):(o+=","+$(c).attr("attrId"),n+=" "+$(c).text())}),e){var c=$("#goods_number").val();axios.post(editGoods[conf],transformRequest({goods_id:t.goods_id,cart_id:t.cart_id,attr:o,num:c,token:toke}),{headers:header}).then(function(t){var e=t.data.res,o=t.data.msg;1==e?(checkedGoods(),layer.open({content:o,skin:"msg",time:2}),vm.showView()):layer.open({content:o,skin:"msg",time:2})})}$.closeModal(".popup-about")}}}),vm=new Vue({el:"#shopping_cart",data:{shoppingList:[],totalMoney:0,checkAll:!1,currentProduct:"",delBtn:!0,checked:[],baseNum:0,loadingFlag:!0,shopflag:!0,donation:!1},computed:{allChecked:{get:function(){return this.checkedCount=this.shoppingList.length},set:function(t){this.checked=t?this.shoppingList.map(function(t){return t.name}):[]}},checkedCount:{get:function(t){return t.checked.length}}},mounted:function(){var t=this;t.$nextTick(function(){t.showView()})},filters:{formatQcb:function(t,e){return e||(e=1),t*e},formatMoney:function(t,e){return e||(e=1),"￥"+(t*e).toFixed(2)}},methods:{showView:function(){var t=this;axios.get(goodsList[conf],{token:toke}).then(function(e){var o=e.data;t.loadingFlag=!1,o&&"1"==o.res&&(t.shoppingList=o.data,t.shopflag=!1)})},getTitleHref:function(t){return"goods-detail.html?id="+t},changeMoney:function(t,e){var o=this,n=t.number,c=t.kucun;e>0?n<c?t.number++:(t.number=t.kucun,layer.open({content:"库存不足！",skin:"msg",time:1})):--t.number<1&&(t.number=1),axios.post(editGoods[conf],transformRequest({goods_id:t.goods_id,cart_id:t.id,num:t.number,token:toke})).then(function(e){var o=e.data;1==o.res||(t.number--,$.toast(o.msg))}),o.$nextTick(function(){checkedGoods()})},delGoods:function(t,e){var o=this;o.currentProduct=t;var n=o.currentProduct.id;o.currentProduct.shopid;"undefined"==o.currentProduct&&o.$set(t,"checked",!0),$.confirm("确认删除吗？",function(e){$.swipeoutClose("li.swipeout"),axios.post(delGoods[conf],transformRequest({ids:n,token:toke})).then(function(e){var n=e.data;if(n||"1"==n.res){if($("input[data-delcc="+t.id+"]").prop("checked")){var c=$("#ck_lenght").text(),i=$("#count_qcb").text(),a=$("#count_price").text(),r=t.sell_price*t.number,s=t.price*t.number;$("#count_qcb").text(i-s),$("#count_price").text((a-r).toFixed(2)),$("#ck_lenght").text(c-1),1==c&&$(".ccart-list").remove(),o.$nextTick(function(){vm.showView()}),$.toast("删除成功")}else{$(".count-price").length<=1&&($(".ccart-list").remove(),vm.showView()),o.$nextTick(function(){vm.showView()})}}else $.toast("删除失败")})})},showEdit:function(t){$.popup(".popup-about"),this.$nextTick(function(){goodsAttr.showParameter(t)})},getCoupon:function(t){$.popup(".popup-stageticket"),this.$nextTick(function(){coupon.showCoupon(t)})},checkedGood:function(t){var e=$("input[data-sub='"+t+"']").length,o=$("input[data-sub='"+t+"']:checked").length;e===o&&o>0?($("input[data-top='"+t+"']").prop("checked",!0),$("input[data-top='"+t+"']").attr("status","1")):($("input[data-top='"+t+"']").prop("checked",!1),$("input[data-top='"+t+"']").attr("status","0")),checkedGoods()},shopAllGoods:function(t){var e=this,o=$("input[data-top='"+t.shopid+"']").attr("status");$("input[data-top='"+t.shopid+"']").attr("status"),"0"===o?(e._data.checkAll=!0,$("input[data-top='"+t.shopid+"']").attr("status","1")):(e._data.checkAll=!1,$("input[data-top='"+t.shopid+"']").attr("status","0")),$("input[data-pro='"+t.shopid+"']").prop("checked",e._data.checkAll),checkedGoods()}}});$("#sub_shopping").on("click",function(){var t=[],e="";if($(".count-price").each(function(e,o){if($(this).is(":checked")){var n=$(this).attr("id");t.push(n)}}),e=t.join(","),0==e.length)return $.toast("请选择商品！"),!1;location.href="confirmOrder.html?attr="+e+"&token="+toke}),$("#check_all").on("click",function(t){var e=$(this).prop("checked");$(".count-price").prop("checked",e),$('#shopping_cart input[type="checkbox"]').each(function(t,o){e?$(this).prop("checked",!0):$(this).prop("checked",!1)}),checkedGoods()});var header={"content-type":"application/x-www-form-urlencoded"},coupon=new Vue({el:".popup-stageticket",data:{couponList:[]},filters:{couponsMoney:function(t,e){return 1==e?"七彩币"+t:2==e?"￥"+t:void 0},receiveStatus:function(t){return value=1==t?"已领取":"领券"}},mounted:function(){},methods:{showCoupon:function(t){axios.post(couponsList[conf],transformRequest({shop_id:t.shopid,token:toke})).then(function(t){var e=t.data;coupon.couponList=e,0==e.res&&$(".sp-box").hide()})},receiveCoupons:function(t){"领券"==$("#"+t).html()&&axios.post(couponList[conf],transformRequest({discount_coupon_id:t,token:toke}),{headers:header}).then(function(e){var o=e.data.res,n=e.data.msg;1==o?($("#"+t).html("已领取"),layer.open({content:"成功领取优惠券",skin:"msg",time:2})):layer.open({content:n,skin:"msg",time:2})})}}});$.init();