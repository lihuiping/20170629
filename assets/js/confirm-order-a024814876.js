function getQueryString(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),o=window.location.search.substr(1).match(e);return null!=o?unescape(o[2]):null}function transformRequest(t){var e="";for(var o in t)e+=encodeURIComponent(o)+"="+encodeURIComponent(t[o])+"&";return e}function getCouponPub(){axios.post(payStyle[conf],transformRequest({condition_price:vm.condition_price,shopid:vm.shopid,token:toke})).then(function(t){var e=t.data.data;null!=e&&(vm.couponList=e,vm.qicai=e.qicai,vm.xianjin=e.xianjin)})}function getaddress_info(t){$.ajax({type:"GET",async:!1,url:address_info[conf],cache:!1,dataType:"json",success:function(t){var e=t;new Vue({el:"#address",data:e})}})}function getorder_info(){$.ajax({type:"get",async:!1,url:order_info[0],cache:!1,data:{userId:"1"},success:function(t){var e=t;new Vue({el:"#getOrder",data:e})},error:function(t){}})}function checkedGoods(){var t=0,e=0,o=0;$(".item-inner .ccart-price").each(function(n,a){o++;var r=parseInt($(this).data("nums"));t+=parseInt($(this).data("qcb"))*r,e+=parseFloat($(this).data("price"))*r}),$("#count_qcb").text(t),$("#count_price").text(e.toFixed(2))}var conf=1,toke=token(),address_info=["../assets/data/address.json",baseUrl()+"member.php?r=address&m=getDefAddress&token="+toke],orderSubmit=["../assets/data/shopping-cart.json",baseUrl()+"index.php?r=cart&token="+toke],normsList=["",baseUrl()+"index.php?r=cart&m=get_cart_goods_attr&token="+toke],editGoods=["",baseUrl()+"index.php?r=cart&m=editcart&token="+toke],subOrder=["",baseUrl()+"member.php?r=order&m=doOrder&uid=1&token="+toke],peisong=["",baseUrl()+"index.php?r=shipping&token="+toke],payStyle=["",baseUrl()+"index.php?r=User_discount_coupon&m=getOrderCoupon&token="+toke],couponsList=["../assets/data/coupons.json",baseUrl()+"index.php?r=Discount_coupon&m=getShopCoupon&token="+toke],couponList=["../assets/data/coupons.json",baseUrl()+"index.php?r=User_discount_coupon&m=addUserCoupon&token="+toke],attrList=getQueryString("attr"),header={"content-type":"application/x-www-form-urlencoded"},addressModel=new Vue({el:"#address",data:{addList:[],attrList:attrList},mounted:function(){this.showMode()},methods:{showMode:function(){var t=this;axios.post(address_info[conf],transformRequest({token:toke})).then(function(e){var o=e.data;t.addList=o,0==o.res?($(".addAddress").show(),$(".addressList").hide()):($(".addAddress").hide(),$(".addressList").show())})}}}),flag=!1,goodid=getQueryString("attr"),shopids="",vm=new Vue({el:"#order_list",data:{orderList:[],totalMoney:0,shopid:"",currentProduct:"",delBtn:!0,goods:[],donation:!1,type:"",loadingFlag:!0,typeQc:[],qicai:[],xianjin:[],couponList:[],payType:1,prefix:"",shopCoupon:"",adminCoupon:"",shopCouponId:"",adminCouponId:"",payment:"",condition_price:""},computed:{totalSumCny:function(){var t=0;return this.orderList.able.forEach(function(e,o){e.cartlist.list.forEach(function(e,o){t+=e.price*e.number})}),parseInt(t)},totalSumQcb:function(){var t=0;return this.orderList.able.forEach(function(e,o){e.cartlist.list.forEach(function(e,o){t+=e.sell_price*e.number})}),parseInt(t)}},mounted:function(){this.showView(),this.getCoupon()},filters:{formatQcb:function(t,e){return e||(e=1),t*e},formatMoney:function(t,e){return e||(e=1),"￥"+(t*e).toFixed(2)}},methods:{showView:function(t){var e=this,o=getQueryString("attr");axios.post(orderSubmit[conf],transformRequest({attr:o})).then(function(t){var o=t.data;e.loadingFlag=!1,e.orderList=o.data,"1"==o.res?(e.orderList.able.forEach(function(t,o){e.shopid+=t.shopid+","}),flag=!0,e.$nextTick(function(){checkedGoods()})):($.toast(o.msg+",正在前往首页..."),setTimeout(function(){window.location.href="./index.html"},1e3))})},getCoupon:function(){var t=this;setTimeout(function(){var e=$("#count_qcb").text();$("#count_price").text();t.condition_price=parseInt(e),getCouponPub()},1500),1==t.payType&&($(".pay-qc").show(),$(".pay-cny").hide())},selectAdd:function(t,e){shippingMethod.showMode(t,e)},getTitleHref:function(t){return"goods-detail.html?id="+t},shopTotalCNY:function(t,e){var o=0;return t.cartlist.list.forEach(function(t,e){o+=t.price*t.number}),parseInt(o)},shopTotalQCB:function(t,e){var o=0;return t.cartlist.list.forEach(function(t,e){o+=t.sell_price*t.number}),parseInt(o)},payMethod:function(t){var e=this,o=$("#count_qcb").html(),n=$("#count_price").html();1==t?(e.payType=1,vm.condition_price=parseInt(o),$(".pay-qc").show(),$(".pay-cny").hide(),getCouponPub()):(e.payType=2,vm.condition_price=parseInt(n),$(".pay-qc").hide(),$(".pay-cny").show(),getCouponPub())}}}),shippingMethod=new Vue({el:"#shipping-method",data:{expressList:[],checked:[],shopId:"",isCheck:"",flag:!1},mounted:function(){},methods:{showMode:function(t,e){var o=this;o.shopId=e,axios.post(peisong[conf],transformRequest({goods_id:e})).then(function(t){var e=t.data.data;o.expressList=e,o.isCheck=1})},receiveExpres:function(){},selectExpress:function(t,e,o){var n=this;axios.post(peisong[conf],transformRequest({goods_id:o,number:e})).then(function(t){var o=t.data.data;n.isCheck=e,shippingMethod.expressList=o})}}}),qcPay=baseUrl()+"index.php?r=pay&m=moneyPay",cnyPay=baseUrl()+"index.php?r=pay&m=vxpay",openid=Cache.get("openid");$("#sub_order").on("click",function(){var t="",e="",o="",n=$(".address-send").val(),a=$(".payfor:checked").val();$(".order-massage").each(function(e){var o=$(".shopid").attr("val"),n=$(this).val(),a=o+":"+n;""==t?t=a:t+=","+a}),$(".order-pei").each(function(t){var o=$(".shopid").attr("val"),n=$(this).val(),a=o+":"+n;""==e?e=a:e+=","+a}),$(".shopid").each(function(t){var e=$(this).attr("val"),n=$(".user-coupon").val(),a=$(".pt-coupon").val(),r=e+":"+n+"."+a;""==o?o=r:o+=","+r});var r={addressId:n,cartIds:attrList,message:t,coupon:o,shippingId:e,exchange_type:a,token:toke};if(""==n||void 0==n)return $.toast("请选择收货地址！"),!1;vm.loadingFlag=!0,$.ajax({type:"post",url:subOrder[conf],async:!0,timeout:2e3,data:r,success:function(t){var e=JSON.parse(t),o=e.data.orderIds,n=e.data.trade_sn,a=e.data.pay_money,r=e.data.shipping_fee,s={orderIds:o,trade_sn:n,pay_money:a,shipping_fee:r,token:toke};if(0==e.res)return $.toast(e.msg),!1;if(isWenxin&&""!=openid)if(vm.loadingFlag=!1,1==e.data.trade_type)$.ajax({type:"post",url:qcPay,async:!0,timeout:1500,data:s,success:function(t){if("1"==t.res&&t.data.amount>0){if(""==openid)return!1;FUQIANLA.init({appId:"VWT0GaNzbX3Dqesop5zrOg",merchId:"m1610030006",orderId:t.data.orderIds,channel:"wx_pay_pub",amount:"0.01",subject:t.data.subject,notifyUrl:"http://my.shop.7cai.tv/pay.php",extra:{openid:openid,cb:function(){window.location.href="./myOrder-table.html"}}})}else"1"==t.res&&0==t.data.amount?($.toast("支付成功"),setTimeout(function(){window.location.href="./myOrder-table.html"},1e3)):$.toast(t.msg)}});else{if(0!=e.data.trade_type)return $.toast("提交订单失败！"),!1;$.ajax({type:"post",url:cnyPay,async:!0,timeout:1500,data:s,success:function(t){"1"==t.res?FUQIANLA.init({appId:"VWT0GaNzbX3Dqesop5zrOg",merchId:"m1610030006",orderId:t.data.orderId,channel:"wx_pay_pub",amount:"0.01",subject:t.data.subject,notifyUrl:"http://my.shop.7cai.tv/pay.php",extra:{openid:openid,cb:function(){window.location.href="./myOrder-table.html"}}}):$.toast(t.msg)}})}else isWenxin&&!openid?$.toast("没有获取到用户ID!"):$.ajax({type:"post",url:cnyPay,async:!0,timeout:1500,data:s,success:function(t){"1"==t.res?FUQIANLA.init({appId:"VWT0GaNzbX3Dqesop5zrOg",merchId:"m1610030006",orderId:t.data.orderId,channel:"ali_pay_wap",amount:"0.01",subject:t.data.subject,notifyUrl:"http://my.shop.7cai.tv/pay.php",extra:{return_url:"./myOrder-table.html"}}):$.toast(t.msg)}})},error:function(){return $.toast("请求超时"),!1}})}),$(function(){}),$.init();